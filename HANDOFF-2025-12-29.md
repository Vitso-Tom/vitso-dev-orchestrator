# AITGP Session Handoff - December 29, 2025 (Updated)

## Session Summary
This session diagnosed fundamental reliability issues with the research agent and designed/implemented Research Agent V2 with caching, verification, and direct fetching.

---

## CRITICAL: AITGP Deployment

**The AITGP (AI Tool Governance Platform) is NOT managed by VDO's deployment system.**

- **Location:** `/mnt/demo-output/job-53` inside the backend container
- **Type:** Flask app on port 5050
- **Process:** Manual, runs as child of backend container
- **KILLED BY:** Any backend file edit (WatchFiles triggers reload, kills child processes)

### Restart Command:
```bash
docker compose -f ~/vitso-dev-orchestrator/docker-compose.yml exec -d backend bash -c "cd /mnt/demo-output/job-53 && flask run --host=0.0.0.0 --port=5050"
```

### After Any Backend Code Changes:
1. Save your edits
2. Wait for WatchFiles reload message in logs
3. Run the restart command above
4. Verify at http://localhost:5050

---

## RESEARCH AGENT V2 - NEW ARCHITECTURE

### The Problem (V1)
- Fact count varied wildly: 59-133 facts across runs (2x variability)
- Critical HIPAA BAA finding: found ~50% of the time
- Every assessment started from scratch
- Web search results are non-deterministic
- Same query, different Google results = different facts

### The Solution (V2) - Three-Phase Flow

```
PHASE 1: DATABASE LOOKUP
├── Check vendor_facts for cached, verified facts
├── Fresh + verified → use directly (instant)
├── Stale → queue for recheck
└── Missing → queue for research

PHASE 2: SOURCE RECHECK  
├── For stale facts with source_url
├── Fetch original URL
├── Claude verifies: "Does this still say [fact]?"
├── If confirmed → refresh, reuse
└── If changed/gone → flag for research

PHASE 3: NEW RESEARCH
├── 3A: Direct fetch vendor trust center (deterministic)
│   └── cursor.com/security, trust.anthropic.com, etc.
├── 3B: Web search (discovery)
│   └── Find third-party analysis, incidents, news
└── Save all verified facts to database
```

### Performance Impact

| Scenario | V1 Time | V2 Time |
|----------|---------|---------|
| First assessment | ~2 min | ~2 min |
| Same-day repeat | ~2 min | <10 sec |
| 31 days later | ~2 min | ~30 sec |
| Low confidence | ~2 min | ~45 sec |

### New Database Tables

```sql
vendor_registry      -- Known vendors with trust center URLs
vendor_facts         -- Persistent, verified facts with TTL
fact_verification_log -- Full audit trail of all verification
```

### New Files Created

```
backend/
├── research_agent_v2.py       # New three-phase research agent
├── research_models_v2.py      # New SQLAlchemy models
├── vendor_registry_seed.py    # 20+ vendors with trust center URLs
└── migrations/
    └── 001_research_agent_v2.py  # Migration script

docs/
└── RESEARCH-AGENT-V2-DESIGN.md   # Full architecture doc
```

### To Deploy V2

```bash
# 1. Run migration
docker exec vitso-backend python /app/migrations/001_research_agent_v2.py

# 2. Verify tables created
docker exec vitso-postgres psql -U vitso -d vitso_dev_orchestrator -c "\dt vendor_*"

# 3. Update research_routes.py to use research_agent_v2 (TODO)

# 4. Restart backend
docker compose -f ~/vitso-dev-orchestrator/docker-compose.yml restart backend
```

### V2 Not Yet Wired Up
The V2 agent is written but not yet integrated into:
- `research_routes.py` - still calls V1
- `orchestrator.py` - still calls V1
- AITGP `app.py` - still calls V1 via `/api/research-vendor`

Next session should:
1. Run migration
2. Update routes to use V2
3. Test with Cursor
4. Compare results to V1

---

## Research Agent V1 - STILL ACTIVE

### Verified Working:
- ✅ Database tables: `research_logs`, `research_queries`, `research_facts`
- ✅ FastAPI routes in `main.py`
- ✅ `/api/research-vendor` endpoint functional
- ✅ Pipeline: ResearchAgent (Claude) → AuditAgent (OpenAI) → Database

### V1 Files:
```
backend/
├── research_agent.py       # Claude web search + extraction (V1)
├── audit_agent.py          # OpenAI cross-checking
├── research_routes.py      # FastAPI router
├── research_models.py      # SQLAlchemy models (V1)
└── orchestrator.py         # Contains research_vendor() method
```

### Known V1 Issues:
- Web search variability (59-133 facts per run)
- HIPAA BAA found inconsistently
- No caching between assessments
- No source URL verification

---

## AITGP App Configuration

### save_to_db Setting
**Location:** `/mnt/demo-output/job-53/app.py`

The `save_to_db` parameter controls whether research results persist:
```python
# Current setting (should be True for audit trail)
"save_to_db": True
```

If research results aren't appearing in database, check this setting.

---

## Docker Stack Reference
```
vitso-postgres    :5432   - PostgreSQL 15
vitso-redis       :6379   - Redis 7
vitso-backend     :8000   - FastAPI (VDO API)
vitso-frontend    :3000   - React (VDO UI)
vitso-worker      -       - RQ Worker
AITGP (Job 53)    :5050   - Flask (manual process)
```

---

## MCP Filesystem Config (Working)

**Location:** `%APPDATA%\Claude\claude_desktop_config.json`

```json
{
  "mcpServers": {
    "fsDesktop": {"command": "npx", "args": ["-y", "@modelcontextprotocol/server-filesystem", "C:/Users/thoma/OneDrive/Desktop"]},
    "fsDownloads": {"command": "npx", "args": ["-y", "@modelcontextprotocol/server-filesystem", "C:/Users/thoma/Downloads"]},
    "fsVDO": {"command": "npx", "args": ["-y", "@modelcontextprotocol/server-filesystem", "//wsl.localhost/Ubuntu/home/temlock/vitso-dev-orchestrator"]},
    "fsAIWorkspace": {"command": "npx", "args": ["-y", "@modelcontextprotocol/server-filesystem", "//wsl.localhost/Ubuntu/home/temlock/ai-workspace"]}
  }
}
```

---

## Backup Location
```
~/aitgp-backup-20251229-004623/
```
Contains Job 53 app files (NOT backend research agent files).

---

## Test Commands

### Verify backend running:
```bash
docker logs vitso-backend --tail 20
```

### Verify V1 research tables:
```bash
docker exec vitso-postgres psql -U vitso -d vitso_dev_orchestrator -c "\dt research_*"
```

### Verify V2 tables (after migration):
```bash
docker exec vitso-postgres psql -U vitso -d vitso_dev_orchestrator -c "\dt vendor_*"
```

### Test research endpoint:
```bash
curl -X POST http://localhost:8000/api/research-vendor \
  -H "Content-Type: application/json" \
  -d '{"vendor_name": "Cursor", "product_name": "Cursor IDE"}'
```

### Query cached facts (after V2):
```bash
docker exec vitso-postgres psql -U vitso -d vitso_dev_orchestrator -c "
SELECT fact_key, fact_value, verification_status, confidence_score 
FROM vendor_facts 
WHERE vendor_name = 'Anysphere'
ORDER BY fact_category, fact_key
"
```

### Restart AITGP:
```bash
docker compose -f ~/vitso-dev-orchestrator/docker-compose.yml exec -d backend bash -c "cd /mnt/demo-output/job-53 && flask run --host=0.0.0.0 --port=5050"
```

---

## Session Files Created

```
docs/RESEARCH-AGENT-V2-DESIGN.md      # Architecture document
backend/research_agent_v2.py          # New research agent
backend/research_models_v2.py         # New database models
backend/vendor_registry_seed.py       # Vendor trust center URLs
backend/migrations/001_research_agent_v2.py  # Migration script
SESSION-COMMANDS-2025-12-29.md        # All commands used this session
```

---

## Next Steps

1. **Run V2 migration** - Creates new tables, seeds vendor registry
2. **Wire up V2** - Update routes to use `research_agent_v2`
3. **Test first assessment** - Should work like V1 but save to new tables
4. **Test repeat assessment** - Should be near-instant from cache
5. **Test after 31 days** - Should recheck source URLs, not full re-search
6. **Compare HIPAA BAA detection** - Should be more reliable with direct fetch

---

## Architecture Decision Record

**Problem:** Research agent produces unreliable results (59-133 facts, inconsistent HIPAA BAA detection)

**Root Cause:** Web search is non-deterministic. Same query returns different results.

**Decision:** Three-phase architecture:
1. Cache verified facts with TTL
2. Recheck sources instead of re-searching
3. Direct fetch known vendor trust centers
4. Fall back to web search for discovery

**Trade-offs:**
- More complex code
- Database storage for facts
- Initial assessment still variable
- But: Repeat assessments reliable, critical fields deterministic

**Alternatives Rejected:**
- Multiple search runs + aggregation (slow, expensive)
- Temperature=0 only (helps extraction, not search)
- Stricter prompts (reduced coverage)
